<!DOCTYPE html>
<html>
<style>

body {
  margin: 0;
}

</style>
<body>
<label for="male">Num of disks:</label><input type="text" style="width: 70px" id="numDisks" value="15">
<label for="male">Epsilon</label><input type="text" style="width: 70px" id="epsilon" value="0.1">
<label for="male">Width</label><input type="text" style="width: 70px" id="width" value="width">
<label for="male">Height</label><input type="text" style="width: 70px" id="height" value="height">
<label for="male">Radius</label><input type="text" style="width: 70px" id="radius" value="10">

<button onclick="scatter()">Scatter</button>

<p id="test"> </p>


<button onclick="findAllIntersect()">Show Intersected</button>
<button onclick="deleteIntersected()">Delete Intersected</button>
<button onclick="calculateMIS()">Get MIS</button>

<p style="display:inline"> Disks deleted: </p>
<p style="display:inline" id="del_disks"></p>
<p style="display:inline; padding: 20px"> MIS: </p>
<p style="display:inline" id="mis"></p>
<p style="display:inline; padding: 20px"> MIS error: </p>
<p style="display:inline" id="error"></p>

<div id="container"></div>

<p id="test"> </p>

<script>

// clear correlation between grid size and number of disks...
var c = 1.5;
var arr_circles = [];
var radius = 10;
var epsilon = 0.4;
var numDisks = 15;
var grid_width = Math.ceil(window.innerWidth/2);
var grid_height = Math.ceil(window.innerHeight/2);
var k = 0;
var numDeleted = 0;

document.getElementById("height").value = grid_height;
document.getElementById("width").value = grid_width;
document.getElementById("numDisks").value = numDisks;
document.getElementById("epsilon").value = epsilon;
document.getElementById("radius").value = radius;

var container = document.getElementById("container");
container.style.position = "relative";


scatter();

function setK(){
    return (4*radius/epsilon); 
}


function calculateMIS(){
    deleteIntersected();
    document.getElementById("mis").innerHTML = calcMIS();

}

function cellMIS(i, j){
    var x_min = i * k;
    var y_min = j * k;
    var bucket = [];

    for(idx = 0; idx < arr_circles.length; idx ++){
        var circle = arr_circles[idx];
        var center = returnCenter(circle);
        if(center[0] >= x_min 
            && center[0] < x_min + k 
            && center[1] >= y_min 
            && center[1] < y_min + k){

            bucket.push(circle);
        }
    }

    return calculateMISinBucket(bucket);

}

function calcMIS(i = -1, j = -1){

    if(i < 0){
        var width_num_cells = grid_width/k;
        var height_num_cells = grid_height/k;
        var totalMIS = 0;

        for(i = 1; i <= width_num_cells; i++){
            for(j = 1; j <= height_num_cells; j++){       
                totalMIS += cellMIS(i, j);
            }
        }
        return totalMIS;
    }else{
        return cellMIS(i, j);
    }
}

function* subsets(array, offset = 0) {
  while (offset < array.length) {
    let first = array[offset++];
    for (let subset of subsets(array, offset)) {
      subset.push(first);
      yield subset;
    }
  }
  yield [];
}

function calculateMISinBucket(bucket){
    var mis_bucket = 0;
    var flag = false;
    var arr = Array.from(Array(bucket.length).keys())

    for (let subset of subsets(arr)) {
        flag = false;
        for(i = 0; i < subset.length; i++){
            for(j = 0; j < subset.length; j++){
                var c1 = returnCenter(bucket[i]);
                var c2 = returnCenter(bucket[j]);
                var intersects = Math.hypot(c1[0]-c2[0], c1[1]-c2[1]) <= (2*radius);

                console.log("YO");
                if(intersects){
                    console.log("TRUE");
                    flag = true;
                    break;
                }
            }

            if(flag) break;
        }
        if(!flag && subset.length > mis_bucket)
            mis_bucket = subset.length;


    }
    console.log("---->>>" + mis_bucket);
    return mis_bucket;
}

function scatter(){

    while (container.firstChild) {
        container.removeChild(container.firstChild);
    }

    var input_disks = document.getElementById("numDisks").value;
    var input_epsilon = document.getElementById("epsilon").value;
    var input_width = document.getElementById("width").value;
    var input_height = document.getElementById("height").value;
    var input_radius = document.getElementById("radius").value;

    if( !isNaN(input_disks) ) 
        numDisks = Math.ceil(parseFloat(input_disks));
    if( !isNaN(input_epsilon) ) 
        epsilon = parseFloat(input_epsilon);
    if( !isNaN(input_height) && input_height/window.innerHeight > 0.1 ) 
        grid_height = Math.ceil(parseFloat(input_height));
    if( !isNaN(input_width) && input_width/window.innerWidth > 0.1) 
        grid_width = Math.ceil(parseFloat(input_width));
    if( !isNaN(input_radius)) 
        radius = Math.ceil(parseInt(input_radius));
    numDeleted = 0;

    k = setK();

    //create grid
    for(var i = 0; i < window.innerWidth/k; i++){
        for(var j = 0; j < window.innerHeight/k; j++){
        var cell = document.createElement('div');
        cell.style.boxSizing = "border-box";
        cell.style.height = k + 'px';
        cell.style.width = k + 'px';
        cell.style.border = "1px solid #D3D3D3";
        cell.style.float = "left";
        cell.style.position = "relative";
        container.appendChild(cell);
       }
    }    

    arr_circles = [];
    
    for(i = 0; i < numDisks; i++){
        var circle = document.createElement('circle');
        circle.style.cssText = 'border-radius: 50%; position: absolute; text-align: center; color: red;';
        //circle.style.border = "2px solid black";
        circle.style.width = radius*2 + "px";
        circle.style.height = radius*2 + "px";
        circle.style.background = "#"+((1<<24)*Math.random()|0).toString(16);
        circle.style.left = Math.round(Math.random() * (grid_width - radius*2.5) + radius) + "px";
        circle.style.top = Math.round(Math.random() * (grid_height - radius*2.5) + radius) + "px";
        arr_circles.push(circle);
        container.appendChild(circle);
        dragElement(circle);


    }

    //randomShift();
    //shift()
    
    //Make the DIV element draggagle:
    //dragElement(document.getElementById(("circle")));

    function dragElement(elmnt) {
      var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
      elmnt.onmousedown = dragMouseDown;
      

        function dragMouseDown(e) {
            e = e || window.event;
            // get the mouse cursor position at startup:
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // call a function whenever the cursor moves:
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            // calculate the new cursor position:
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // set the element's new position:
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            /* stop moving when mouse button is released:*/
            document.onmouseup = null;
            document.onmousemove = null;
            document.getElementById("test").innerHTML = returnCenter(elmnt) + "  " + checkIntersect(circle);
        }

    }
}

//circle center top + 20, left + 20

function returnCenter(circle){
    var style = window.getComputedStyle(circle);
    var left_val = parseFloat(style.getPropertyValue("left").slice(0, -2));
    var top_val = parseFloat(style.getPropertyValue("top").slice(0, -2)); 
    return [left_val+radius, top_val+radius];
}

function checkIntersect(circle){
    var center = returnCenter(circle);
    var rem_x = center[0]%k;
    var rem_y = center[1]%k;
    if(rem_x > k-radius || rem_x < radius || rem_y > k-radius || rem_y < radius)
        return 1
    else
        return 0
}

function findAllIntersect(){
    for(i = 0; i < arr_circles.length; i++){
        circle = arr_circles[i];
        //console.log(circle);
        if(checkIntersect(circle)){
            circle.style.background = "black";
            circle.style.border = "3px solid red";
        }else if(circle.style.background == "black"){
            circle.style.background = "#"+((1<<24)*Math.random()|0).toString(16);
            //circle.style.border = "2px solid black";
        }
    }
}

function deleteIntersected(){
    for(i = 0; i < arr_circles.length; i++){
        circle = arr_circles[i];
        if(checkIntersect(circle)){
            numDeleted += 1;
            arr_circles.slice(i, 1);
            container.removeChild(circle);
        }
    } 
    document.getElementById("del_disks").innerHTML = Math.floor((numDeleted/numDisks)*100) + "%";

}
// function shift(){
//     var circle = arr_circles[0];
//     var style = window.getComputedStyle(circle);
//     var left_val = parseInt(style.getPropertyValue("left").slice(0, -2));
//     var top_val = parseInt(style.getPropertyValue("top").slice(0, -2)); 
//     circle.style.left = k - radius + "px";
//     circle.style.top = k - radius + "px";
//     var center_coordinate = returnCenter(circle);
//     console.log("center is ", center_coordinate[0], center_coordinate[1]);
// }



function randomShift(){
    var min_x = 1;
    var max_x = grid_width - radius - 1;

    var min_y = 1;
    var max_y = grid_height - radius - 1;

    var shift_x = Math.random() * (max_x - min_x) + min_x;
    var shift_y = Math.random() * (max_y - min_y) + min_y;


    for(i = 0; i < arr_circles.length; i++){
        var circle = arr_circles[i];
        var style = window.getComputedStyle(circle);
        var left_val = parseInt(style.getPropertyValue("left").slice(0, -2));
        var top_val = parseInt(style.getPropertyValue("top").slice(0, -2)); 
        circle.style.left = left_val + shift_x + "px";
        circle.style.top = top_val + shift_y + "px";
    }
}

</script>

</body>
</html>

